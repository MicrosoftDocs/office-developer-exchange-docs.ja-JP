---
title: Exchange で EWS と REST のクライアントの要求をインストルメント化する
manager: sethgros
ms.date: 4/13/2016
ms.audience: Developer
localization_priority: Normal
ms.assetid: 330de503-498d-447e-b4a9-c20fc1699fd1
description: Exchange アプリケーションのモニターとトラブルシューティングに役立つ EWS と REST の要求と応答の HTTP ヘッダーについて説明します。
ms.openlocfilehash: 3a8ce889ec7a6b9e70ec25a95ac248902f48ca6c
ms.sourcegitcommit: 88ec988f2bb67c1866d06b361615f3674a24e795
ms.translationtype: MT
ms.contentlocale: ja-JP
ms.lasthandoff: 05/31/2020
ms.locfileid: "44456305"
---
# <a name="instrumenting-client-requests-for-ews-and-rest-in-exchange"></a><span data-ttu-id="54155-103">Exchange で EWS と REST のクライアントの要求をインストルメント化する</span><span class="sxs-lookup"><span data-stu-id="54155-103">Instrumenting client requests for EWS and REST in Exchange</span></span>

<span data-ttu-id="54155-104">Exchange アプリケーションのモニターとトラブルシューティングに役立つ EWS と REST の要求と応答の HTTP ヘッダーについて説明します。</span><span class="sxs-lookup"><span data-stu-id="54155-104">Learn about the HTTP headers in EWS and REST requests and responses that can help you monitor and troubleshoot your Exchange application.</span></span>
  
<span data-ttu-id="54155-105">次のような経験があるかもしれません。</span><span class="sxs-lookup"><span data-stu-id="54155-105">Has this ever happened to you?</span></span> <span data-ttu-id="54155-106">アプリケーションのユーザーが予期しないエラーを報告します。</span><span class="sxs-lookup"><span data-stu-id="54155-106">A user of your application reports an unexpected error.</span></span> <span data-ttu-id="54155-107">調査しようとしましたが、再現できません。</span><span class="sxs-lookup"><span data-stu-id="54155-107">You want to investigate, but you can't reproduce it.</span></span> <span data-ttu-id="54155-108">エラーがユーザーに現れなくなり、役に立つデータはほとんどありません。</span><span class="sxs-lookup"><span data-stu-id="54155-108">The error has disappeared for the user, and you're left with very little actionable data.</span></span> <span data-ttu-id="54155-109">これはストレスのたまる状況です。</span><span class="sxs-lookup"><span data-stu-id="54155-109">Frustrating, isn't it?</span></span> <span data-ttu-id="54155-110">このようなシナリオに対して事前に準備し、今後のストレス回避に役立つ可能性のある方法を説明します。</span><span class="sxs-lookup"><span data-stu-id="54155-110">Let's look at how you can proactively prepare for this scenario and hopefully avoid frustration in the future.</span></span>
  
## <a name="add-instrumentation-to-requests"></a><span data-ttu-id="54155-111">要求にインストルメンテーションを追加する</span><span class="sxs-lookup"><span data-stu-id="54155-111">Add instrumentation to requests</span></span>

<span data-ttu-id="54155-p102">トラブルシューティングを容易にするために、要求に HTTP ヘッダーを追加することをお勧めします。後で必要になったら取得できるように、この情報をどこかに (ログ ファイルなど) 記録しておいてください。これは、ネットワーク トラフィックを調べるときに役立ちますが、Microsoft サポートに連絡して支援を求めるときにも役立ちます。</span><span class="sxs-lookup"><span data-stu-id="54155-p102">We recommend that you add additional HTTP headers to your requests to facilitate troubleshooting. You should keep a record of this information somewhere (for example, in a log file) so that you can retrieve it later if you need to. This is helpful when examining network traffic, and is also helpful if you contact Microsoft support for assistance.</span></span>
  
<span data-ttu-id="54155-115">**表 1. トラブルシューティングのための要求ヘッダー**</span><span class="sxs-lookup"><span data-stu-id="54155-115">**Table 1. Request headers for troubleshooting**</span></span>

|<span data-ttu-id="54155-116">**HTTP ヘッダー (EWS)**</span><span class="sxs-lookup"><span data-stu-id="54155-116">**HTTP header (EWS)**</span></span>|<span data-ttu-id="54155-117">**EWS マネージ API の同等物**</span><span class="sxs-lookup"><span data-stu-id="54155-117">**EWS Managed API equivalent**</span></span>|<span data-ttu-id="54155-118">**メモ**</span><span class="sxs-lookup"><span data-stu-id="54155-118">**Notes**</span></span>|
|:-----|:-----|:-----|
|<span data-ttu-id="54155-119">User-Agent</span><span class="sxs-lookup"><span data-stu-id="54155-119">User-Agent</span></span>  <br/> |[<span data-ttu-id="54155-120">ExchangeService.UserAgent</span><span class="sxs-lookup"><span data-stu-id="54155-120">ExchangeService.UserAgent</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.useragent%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="54155-121">クライアント アプリケーションを識別する一意の値に設定します。</span><span class="sxs-lookup"><span data-stu-id="54155-121">Set this to a unique value that identifies your client application.</span></span><br/><br/> <span data-ttu-id="54155-122">アプリケーションが送信するすべての要求に同じ値を使用すると、呼び出しの失敗が発生した場合に、Microsoft がトラブルシューティングを行うのに役立ちます。</span><span class="sxs-lookup"><span data-stu-id="54155-122">Using the same value for all requests that your application sends allows Microsoft to help troubleshoot call failures, should they arise.</span></span>  <br/> |
|<span data-ttu-id="54155-123">client-request-id</span><span class="sxs-lookup"><span data-stu-id="54155-123">client-request-id</span></span>  <br/> |[<span data-ttu-id="54155-124">ExchangeService.ClientRequestId</span><span class="sxs-lookup"><span data-stu-id="54155-124">ExchangeService.ClientRequestId</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.clientrequestid%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="54155-125">アプリケーションが送信する要求ごとに異なる一意の値に設定します。</span><span class="sxs-lookup"><span data-stu-id="54155-125">Set this to a different unique value for every request your application sends.</span></span><br/><br/> <span data-ttu-id="54155-126">GUID を使用することをお勧めします。</span><span class="sxs-lookup"><span data-stu-id="54155-126">We recommend that you use a GUID.</span></span> <span data-ttu-id="54155-127">この一意の識別子は、問題が発生した場合に 2 つのシステムの間でアクティビティを関連付けるために使用されます。</span><span class="sxs-lookup"><span data-stu-id="54155-127">This unique identifier is intended to be used to correlate activities between two systems in the event that something goes wrong.</span></span>  <br/> |
|<span data-ttu-id="54155-128">return-client-request-id</span><span class="sxs-lookup"><span data-stu-id="54155-128">return-client-request-id</span></span>  <br/> |[<span data-ttu-id="54155-129">ExchangeService.ReturnClientRequestId</span><span class="sxs-lookup"><span data-stu-id="54155-129">ExchangeService.ReturnClientRequestId</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.returnclientrequestid%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="54155-130">**true** に設定することで、対応する応答で client-request-id の値を返す必要があることを Exchange サーバーに通知します。</span><span class="sxs-lookup"><span data-stu-id="54155-130">Set this to **true** to signal to the Exchange server that it should return the value of your client-request-id in the corresponding response.</span></span><br/><br/> <span data-ttu-id="54155-131">これを使用して、ネットワーク トレースまたは EWS マネージ API のトレースで要求と応答を関連付けることができます。</span><span class="sxs-lookup"><span data-stu-id="54155-131">You can use this to correlate requests and responses in network traces or EWS Managed API traces.</span></span>  <br/> |
|<span data-ttu-id="54155-132">X-ClientStatistics</span><span class="sxs-lookup"><span data-stu-id="54155-132">X-ClientStatistics</span></span>  <br/> |[<span data-ttu-id="54155-133">ExchangeService.SendClientLatencies</span><span class="sxs-lookup"><span data-stu-id="54155-133">ExchangeService.SendClientLatencies</span></span>](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.sendclientlatencies%28v=exchg.80%29.aspx) <br/> |<span data-ttu-id="54155-134">アプリケーションが Exchange Online または Office 365 の一部としての Exchange Online にアクセスしている場合に、Microsoft に [EWS の待機時間を報告](#bk_ReportLatency)するために使用されます。</span><span class="sxs-lookup"><span data-stu-id="54155-134">Used to [report EWS latencies](#bk_ReportLatency) to Microsoft if your application is accessing Exchange Online or Exchange Online as part of Office 365.</span></span>  <br/> |
   
## <a name="log-information-from-responses"></a><span data-ttu-id="54155-135">応答からのログ情報</span><span class="sxs-lookup"><span data-stu-id="54155-135">Log information from responses</span></span>

<span data-ttu-id="54155-p104">クライアントが送信する要求にインストルメンテーションを追加できるのと同様、Exchange も HTTP ヘッダーの形式でインストルメンテーションを応答に追加します。クライアントはこの情報を要求のインストルメンテーションの情報とともにキャプチャする必要があります。</span><span class="sxs-lookup"><span data-stu-id="54155-p104">Just as your client can add additional instrumentation to the requests it sends, Exchange adds additional instrumentation to the responses in the form of HTTP headers. Your client should capture this information to go along with the request instrumentation information.</span></span>
  
> [!NOTE]
> <span data-ttu-id="54155-138">EWS マネージ API を使用している場合、HTTP ヘッダーに直接相当するものはありません。</span><span class="sxs-lookup"><span data-stu-id="54155-138">If you are using the EWS Managed API, there is no direct equivalent for the HTTP headers.</span></span> <span data-ttu-id="54155-139">しかし、すべての HTTP 応答ヘッダーに、[ExchangeService.HttpResponseHeaders](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.httpresponseheaders%28v=exchg.80%29.aspx) プロパティ経由でアクセスできます。</span><span class="sxs-lookup"><span data-stu-id="54155-139">However, all HTTP response headers can be accessed via the [ExchangeService.HttpResponseHeaders](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.httpresponseheaders%28v=exchg.80%29.aspx) property.</span></span> 
  
<span data-ttu-id="54155-140">**表 2. HTTP 応答ヘッダー**</span><span class="sxs-lookup"><span data-stu-id="54155-140">**Table 2. HTTP response headers**</span></span>

|<span data-ttu-id="54155-141">**HTTP ヘッダー**</span><span class="sxs-lookup"><span data-stu-id="54155-141">**HTTP header**</span></span>|<span data-ttu-id="54155-142">**説明**</span><span class="sxs-lookup"><span data-stu-id="54155-142">**Description**</span></span>|
|:-----|:-----|
|<span data-ttu-id="54155-143">request-id</span><span class="sxs-lookup"><span data-stu-id="54155-143">request-id</span></span>  <br/> |<span data-ttu-id="54155-144">この応答に対応する要求を表す、サーバーによって生成される ID。</span><span class="sxs-lookup"><span data-stu-id="54155-144">A server-generated ID for the request that corresponds to this response.</span></span>  <br/> |
|<span data-ttu-id="54155-145">client-request-id</span><span class="sxs-lookup"><span data-stu-id="54155-145">client-request-id</span></span>  <br/> |<span data-ttu-id="54155-146">要求の client-request-id ヘッダーの値。</span><span class="sxs-lookup"><span data-stu-id="54155-146">The value of the client-request-id header in the request.</span></span><br/><br/> <span data-ttu-id="54155-147">このヘッダーは、要求に **true** の値を持つ return-client-request-id ヘッダーが含まれる場合にのみ存在します。</span><span class="sxs-lookup"><span data-stu-id="54155-147">This header is only present if the request contains the return-client-request-id header with a value of **true**.</span></span>  <br/> |
|<span data-ttu-id="54155-148">X-FEServer</span><span class="sxs-lookup"><span data-stu-id="54155-148">X-FEServer</span></span>  <br/> |<span data-ttu-id="54155-149">要求を処理したクライアント アクセス サーバーの FQDN。</span><span class="sxs-lookup"><span data-stu-id="54155-149">The FQDN of the Client Access server that processed the request.</span></span>  <br/> |
|<span data-ttu-id="54155-150">X-TargetBEServer</span><span class="sxs-lookup"><span data-stu-id="54155-150">X-TargetBEServer</span></span>  <br/> |<span data-ttu-id="54155-151">要求を処理したメールボックス サーバーの FQDN。</span><span class="sxs-lookup"><span data-stu-id="54155-151">The FQDN of the mailbox server that processed the request.</span></span>  <br/> |
|<span data-ttu-id="54155-152">X-DiagInfo</span><span class="sxs-lookup"><span data-stu-id="54155-152">X-DiagInfo</span></span>  <br/> |<span data-ttu-id="54155-153">要求に応じた追加の診断情報。</span><span class="sxs-lookup"><span data-stu-id="54155-153">Additional diagnostic information, depending on the request.</span></span>  <br/> |
|<span data-ttu-id="54155-154">x-ms-diagnostics</span><span class="sxs-lookup"><span data-stu-id="54155-154">x-ms-diagnostics</span></span>  <br/> | <span data-ttu-id="54155-155">このヘッダーは、要求で OAuth 認証が使用される場合にのみ適用されます。</span><span class="sxs-lookup"><span data-stu-id="54155-155">This header is only applicable if OAuth authentication is used in the request.</span></span><br/><br/> <span data-ttu-id="54155-156">これには、OAuth 認証が失敗した理由を指定する明示的なエラー コードが含まれます。</span><span class="sxs-lookup"><span data-stu-id="54155-156">It contains an explicit error code that specifies why an OAuth authentication failed.</span></span><br/><br/> <span data-ttu-id="54155-157">次の形式を使用します。`errorId;reason="reason"error_type="error type"`</span><span class="sxs-lookup"><span data-stu-id="54155-157">It takes the following format: `errorId;reason="reason"error_type="error type"`</span></span><br/><br/> <span data-ttu-id="54155-158">**reason** フィールドは、人間が理解しやすい形式でエラーを説明したものです。</span><span class="sxs-lookup"><span data-stu-id="54155-158">The **reason** field is a human-readable description of the error.</span></span><br/><br/> <span data-ttu-id="54155-159">**errorId** フィールドは整数、**error\_type** フィールドは整数の文字列表現であり、次のようになります。</span><span class="sxs-lookup"><span data-stu-id="54155-159">The **errorId** field is an integer, and the **error\_type** field is the string representation of that integer, as follows:</span></span><ul><li><span data-ttu-id="54155-160">2000000: invalid\_signature</span><span class="sxs-lookup"><span data-stu-id="54155-160">2000000: invalid\_signature</span></span></li><li><span data-ttu-id="54155-161">2000001: invalid\_token</span><span class="sxs-lookup"><span data-stu-id="54155-161">2000001: invalid\_token</span></span></li><li>  <span data-ttu-id="54155-162">2000002: token\_expired</span><span class="sxs-lookup"><span data-stu-id="54155-162">2000002: token\_expired</span></span></li><li><span data-ttu-id="54155-163">2000003: invalid\_resource</span><span class="sxs-lookup"><span data-stu-id="54155-163">2000003: invalid\_resource</span></span></li><li><span data-ttu-id="54155-164">2000004: invalid\_tenant</span><span class="sxs-lookup"><span data-stu-id="54155-164">2000004: invalid\_tenant</span></span>  </li><li><span data-ttu-id="54155-165">2000005: invalid\_user</span><span class="sxs-lookup"><span data-stu-id="54155-165">2000005: invalid\_user</span></span></li><li><span data-ttu-id="54155-166">2000006: invalid\_client</span><span class="sxs-lookup"><span data-stu-id="54155-166">2000006: invalid\_client</span></span></li><li><span data-ttu-id="54155-167">2000007: internal\_error</span><span class="sxs-lookup"><span data-stu-id="54155-167">2000007: internal\_error</span></span></li><li><span data-ttu-id="54155-168">2000008: invalid\_grant</span><span class="sxs-lookup"><span data-stu-id="54155-168">2000008: invalid\_grant</span></span></li></ul> |
   
## <a name="report-ews-latency-to-microsoft"></a><span data-ttu-id="54155-169">Microsoft への EWS の待機時間の報告</span><span class="sxs-lookup"><span data-stu-id="54155-169">Report EWS latency to Microsoft</span></span>
<span data-ttu-id="54155-170"><a name="bk_ReportLatency"> </a></span><span class="sxs-lookup"><span data-stu-id="54155-170"><a name="bk_ReportLatency"> </a></span></span>

<span data-ttu-id="54155-171">アプリケーションが EWS マネージ API または EWS を使用して Exchange Online に接続する場合に、EWS 要求の要求の待機時間を Microsoft に直接報告できます。</span><span class="sxs-lookup"><span data-stu-id="54155-171">If your application uses the EWS Managed API or EWS to connect to Exchange Online, you can report latency in EWS requests directly to Microsoft.</span></span> <span data-ttu-id="54155-172">情報は、X-ClientStatistics 要求ヘッダーを使用して渡されます。</span><span class="sxs-lookup"><span data-stu-id="54155-172">The information is passed via the X-ClientStatistics request header.</span></span> <span data-ttu-id="54155-173">EWS マネージ API を使用する場合、必要なのは [ExchangeService.SendClientLatencies](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.sendclientlatencies%28v=exchg.80%29.aspx) プロパティを **true** に設定することだけです。</span><span class="sxs-lookup"><span data-stu-id="54155-173">If you are using the EWS Managed API, all you have to do is set the [ExchangeService.SendClientLatencies](https://msdn.microsoft.com/library/microsoft.exchange.webservices.data.exchangeservicebase.sendclientlatencies%28v=exchg.80%29.aspx) property to **true**.</span></span> <span data-ttu-id="54155-174">EWS を使用する場合は、要求を発行してから応答を受け取るまでの時間を測定し、アプリケーションが送信するその次の EWS 要求に X-ClientStatistics ヘッダーを追加する必要があります。使用する形式は次のとおりです。</span><span class="sxs-lookup"><span data-stu-id="54155-174">If you are using EWS, you'll need to measure the time between issuing a request and receiving a response, then add the X-ClientStatistics header to the next EWS request your application sends, using the following format.</span></span>
  
`X-ClientStatistics: MessageId=<value of request-id header>,ResponseTime=<time in milliseconds>,SoapAction=<EWS operation>`
  
<span data-ttu-id="54155-175">Microsoft はこれらの待機時間の報告を保存し、Exchange Online の EWS のサービスを継続的に改善するために使用します。</span><span class="sxs-lookup"><span data-stu-id="54155-175">We maintain reports for these latencies and use them to continuously improve EWS services in Exchange Online.</span></span>
  
## <a name="next-steps"></a><span data-ttu-id="54155-176">次の手順</span><span class="sxs-lookup"><span data-stu-id="54155-176">Next steps</span></span>
<span data-ttu-id="54155-177"><a name="bk_ReportLatency"> </a></span><span class="sxs-lookup"><span data-stu-id="54155-177"><a name="bk_ReportLatency"> </a></span></span>

<span data-ttu-id="54155-178">クライアントのインストルメンテーションをアプリケーションに追加したので、問題が発生した場合の準備がより一層整いました。</span><span class="sxs-lookup"><span data-stu-id="54155-178">After you've added client instrumentation to your application, you're better prepared if something goes wrong.</span></span> <span data-ttu-id="54155-179">問題が発生した場合は、インストルメンテーション データを使用して[アプリケーションのトラブルシューティング](tools-and-resources-for-troubleshooting-ews-applications-for-exchange.md)を行うことができます。</span><span class="sxs-lookup"><span data-stu-id="54155-179">If that happens, you can use your instrumentation data to [troubleshoot your application](tools-and-resources-for-troubleshooting-ews-applications-for-exchange.md).</span></span>
  
## <a name="see-also"></a><span data-ttu-id="54155-180">関連項目</span><span class="sxs-lookup"><span data-stu-id="54155-180">See also</span></span>

- [<span data-ttu-id="54155-181">Exchange の EWS クライアントの設計の概要</span><span class="sxs-lookup"><span data-stu-id="54155-181">EWS client design overview for Exchange</span></span>](ews-client-design-overview-for-exchange.md)
- [<span data-ttu-id="54155-182">「EWS のマネージ API アプリケーションのトラブルシューティングを行うには、要求と応答をトレースします。」</span><span class="sxs-lookup"><span data-stu-id="54155-182">Trace requests and responses to troubleshoot EWS Managed API applications</span></span>](how-to-trace-requests-responses-to-troubleshoot-ews-managed-api-applications.md)
- [<span data-ttu-id="54155-183">Exchange の EWS アプリケーションのトラブルシューティングに使用するツールとリソース</span><span class="sxs-lookup"><span data-stu-id="54155-183">Tools and resources for troubleshooting EWS applications for Exchange</span></span>](tools-and-resources-for-troubleshooting-ews-applications-for-exchange.md)
    

